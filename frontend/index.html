<script>
  let wallet = "";
  let balanceBTC = 0;
  let balanceDOP = 0;
  let miningInterval = null;
  let miningRate = 0.00000005;

  const storageKeyBalance = (w) => `balance_${w}`;
  const storageKeyHistory = (w) => `history_${w}`;

  function updateBalances() {
    document.getElementById('balance').textContent = `Balance BTC: ${balanceBTC.toFixed(8)}`;
    document.getElementById('balanceDOP').textContent = `Balance DOP: ${convertBTCtoDOP(balanceBTC).toFixed(2)}`;
  }

  function convertBTCtoDOP(btc) {
    return btc * 1200;
  }

  function saveBalance() {
    localStorage.setItem(storageKeyBalance(wallet), balanceBTC);
  }

  function loadBalance() {
    const saved = localStorage.getItem(storageKeyBalance(wallet));
    balanceBTC = saved ? parseFloat(saved) : 0;
    updateBalances();
  }

  function saveHistory(history) {
    localStorage.setItem(storageKeyHistory(wallet), JSON.stringify(history));
  }

  function loadHistory() {
    const raw = localStorage.getItem(storageKeyHistory(wallet));
    return raw ? JSON.parse(raw) : [];
  }

  function showHistory() {
    const history = loadHistory();
    const container = document.getElementById('history');
    container.innerHTML = "";
    if(history.length === 0) {
      container.textContent = "No hay retiros aún.";
      return;
    }
    history.forEach(item => {
      const div = document.createElement('div');
      div.className = 'history-item';
      div.textContent = `Anonymous - Monto: ${item.amount.toFixed(8)} BTC - Fecha: ${new Date(item.date).toLocaleString()}`;
      container.appendChild(div);
    });
  }

  function startMining() {
    if(miningInterval) return;
    miningInterval = setInterval(() => {
      balanceBTC += miningRate;
      updateBalances();
      saveBalance();
    }, 1000);
  }

  function stopMining() {
    if(miningInterval) {
      clearInterval(miningInterval);
      miningInterval = null;
    }
  }

  function resetMining() {
    stopMining();
    balanceBTC = 0;
    updateBalances();
    saveBalance();
  }

  async function hacerRetiro(monto) {
    mostrarMensaje("Procesando retiro...", "#ff0");
    try {
      // Ajusta la URL a tu endpoint correcto
      const res = await fetch("http://localhost:8000/api/retirar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
          // Si usas autenticación, agrega aquí Authorization: "Bearer token"
        },
        body: JSON.stringify({
          wallet: wallet,  // aquí debe coincidir con backend (tu código espera "wallet")
          amount: monto    // y "amount"
        })
      });

      if (!res.ok) {
        // Si status no es 200-299
        const errorText = await res.text();
        mostrarError(`Error ${res.status}: ${errorText || res.statusText}`);
        return;
      }

      const data = await res.json();

      if (data.success) {
        mostrarResultado(data);
        guardarHistorial(data);
        mostrarHistorial();
      } else {
        mostrarError(data.error || "Error desconocido");
      }
    } catch (err) {
      mostrarError("Error de red o servidor: " + err.message);
    }
  }

  function mostrarResultado(data) {
    const div = document.getElementById("retiroResultado");
    div.style.color = "#0f0";
    div.innerHTML = `
      Retiro exitoso:<br>
      Enviado a: ${data.usuario.wallet} <br>
      Monto neto: ${data.usuario.monto_enviado.toFixed(8)} BTC <br>
      Comisión enviada: ${data.comision.monto_enviado.toFixed(8)} BTC
    `;
  }

  function mostrarError(msg) {
    const div = document.getElementById("retiroResultado");
    div.style.color = "#f00";
    div.textContent = "Error: " + msg;
  }

  function mostrarMensaje(msg, color) {
    const div = document.getElementById("retiroResultado");
    div.style.color = color || "#fff";
    div.textContent = msg;
  }

  function guardarHistorial(data) {
    const history = loadHistory();
    history.push({
      amount: data.usuario.monto_enviado,
      date: new Date().toISOString()
    });
    saveHistory(history);
  }

  function mostrarHistorial() {
    const container = document.getElementById("retiroHistorial");
    const history = loadHistory();
    container.innerHTML = "";
    if (history.length === 0) {
      container.innerHTML = "<p style='color:#aaa;'>No hay retiros realizados.</p>";
      return;
    }
    history.slice().reverse().forEach(item => {
      const div = document.createElement("div");
      div.style.borderBottom = "1px solid #444";
      div.style.padding = "5px 0";
      div.innerHTML = `
        <strong>Anonymous</strong><br>
        Fecha: ${new Date(item.date).toLocaleString()}<br>
        Monto neto: ${item.amount.toFixed(8)} BTC
      `;
      container.appendChild(div);
    });
  }

  document.getElementById("btnRetirar").addEventListener("click", () => {
    const montoInput = document.getElementById("montoRetiro");
    const monto = parseFloat(montoInput.value);
    if (isNaN(monto) || monto < 0.000075) {
      mostrarError("Ingresa un monto válido mayor o igual a 0.000075 BTC");
      return;
    }
    if (!wallet) {
      mostrarError("Por favor conecta primero tu wallet BTC");
      return;
    }
    hacerRetiro(monto);
  });

  document.getElementById('btnConnect').onclick = () => {
    const input = document.getElementById('walletInput').value.trim();
    if(!input) {
      alert("Por favor ingresa tu wallet BTC.");
      return;
    }
    wallet = input;
    loadBalance();
    showHistory();
    document.getElementById('btnStartMine').disabled = false;
    document.getElementById('btnResetMine').disabled = false;
    document.getElementById('btnWithdraw').disabled = false;
    alert(`Wallet ${wallet} conectada.`);
  };

  document.getElementById('btnStartMine').onclick = () => {
    startMining();
  };

  document.getElementById('btnResetMine').onclick = () => {
    resetMining();
  };

  document.getElementById('btnWithdraw').onclick = () => {
    stopMining();
    if (balanceBTC < 0.000075) {
      mostrarError("Balance insuficiente para retirar.");
      return;
    }
    hacerRetiro(balanceBTC);
  };

  mostrarHistorial();
</script>
