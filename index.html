<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BTCMovil - Minería y Retiros KuCoin</title>
<style>
  body { font-family: Arial, sans-serif; background: #121212; color: #eee; margin: 0; padding: 20px; }
  h1 { text-align: center; color: #f39c12; }
  #walletInput, #btnConnect, #btnStartMine, #btnResetMine, #btnWithdraw { padding: 10px; margin: 5px; font-size: 1em; }
  #balance { font-size: 2em; margin: 10px 0; text-align: center; }
  #history { max-height: 200px; overflow-y: auto; background: #222; padding: 10px; border-radius: 5px; margin-top: 10px; }
  .history-item { border-bottom: 1px solid #333; padding: 5px 0; }
  .btn { cursor: pointer; background: #f39c12; border: none; border-radius: 4px; color: #121212; font-weight: bold; }
  .btn:disabled { background: #555; cursor: not-allowed; }
  #notice { color: #f39c12; font-weight: bold; margin-top: 10px; text-align: center; }
</style>
</head>
<body>

<h1>BTCMovil - Minería y Retiros KuCoin</h1>

<div style="text-align:center;">
  <input id="walletInput" placeholder="Ingresa tu wallet BTC" size="40" />
  <button id="btnConnect" class="btn">Conectar Wallet</button>
</div>

<div id="balance">Balance BTC: 0.00000000</div>
<div id="balanceDOP" style="text-align:center; margin-bottom: 15px;">Balance DOP: 0</div>

<div style="text-align:center;">
  <button id="btnStartMine" class="btn" disabled>Iniciar Minado</button>
  <button id="btnResetMine" class="btn" disabled>Minado desde el principio</button>
</div>

<div style="text-align:center; margin-top: 20px;">
  <button id="btnWithdraw" class="btn" disabled>Solicitar Retiro BTC</button>
</div>

<div id="notice">Nota: Se cobrará una comisión del 5% sobre el monto retirado.</div>

<h3>Historial de Retiros</h3>
<div id="history"></div>

<script>
// Variables globales
let wallet = "";
let balanceBTC = 0;
let balanceDOP = 0;
let miningInterval = null;
let miningRate = 0.00000005; // BTC minado por tick (simulación)
const commissionRate = 0.05;

// LocalStorage keys
const storageKeyBalance = (w) => `balance_${w}`;
const storageKeyHistory = (w) => `history_${w}`;

// Función para actualizar balance en pantalla
function updateBalances() {
  document.getElementById('balance').textContent = `Balance BTC: ${balanceBTC.toFixed(8)}`;
  document.getElementById('balanceDOP').textContent = `Balance DOP: ${balanceDOP.toFixed(2)}`;
}

// Simular conversión BTC a DOP (ejemplo fijo)
function convertBTCtoDOP(btc) {
  const rate = 1200; // Supongamos 1 BTC = 1200 DOP (ajusta según API real)
  return btc * rate;
}

// Guardar balance localmente
function saveBalance() {
  localStorage.setItem(storageKeyBalance(wallet), balanceBTC);
}

// Cargar balance guardado
function loadBalance() {
  const saved = localStorage.getItem(storageKeyBalance(wallet));
  if(saved) {
    balanceBTC = parseFloat(saved);
    balanceDOP = convertBTCtoDOP(balanceBTC);
  } else {
    balanceBTC = 0;
    balanceDOP = 0;
  }
  updateBalances();
}

// Guardar historial
function saveHistory(history) {
  localStorage.setItem(storageKeyHistory(wallet), JSON.stringify(history));
}

// Cargar historial
function loadHistory() {
  const raw = localStorage.getItem(storageKeyHistory(wallet));
  if(raw) return JSON.parse(raw);
  return [];
}

// Mostrar historial en pantalla con "Anonymous"
function showHistory() {
  const history = loadHistory();
  const container = document.getElementById('history');
  container.innerHTML = "";
  if(history.length === 0) {
    container.textContent = "No hay retiros aún.";
    return;
  }
  history.forEach(item => {
    const div = document.createElement('div');
    div.className = 'history-item';
    div.textContent = `Anonymous - Monto: ${item.amount.toFixed(8)} BTC - Fecha: ${new Date(item.date).toLocaleString()}`;
    container.appendChild(div);
  });
}

// Simulación minado
function startMining() {
  if(miningInterval) return;
  miningInterval = setInterval(() => {
    balanceBTC += miningRate;
    balanceDOP = convertBTCtoDOP(balanceBTC);
    updateBalances();
    saveBalance();
  }, 1000);
}

// Detener minado
function stopMining() {
  if(miningInterval) {
    clearInterval(miningInterval);
    miningInterval = null;
  }
}

// Resetear minado
function resetMining() {
  stopMining();
  balanceBTC = 0;
  balanceDOP = 0;
  saveBalance();
  updateBalances();
}

// Solicitar retiro (simulado con guardado local)
function requestWithdrawal() {
  if(balanceBTC <= 0) {
    alert("No tienes saldo para retirar.");
    return;
  }
  const amountBeforeCommission = balanceBTC;
  const commission = amountBeforeCommission * commissionRate;
  const amountAfterCommission = amountBeforeCommission - commission;

  // Confirmar con el usuario
  const confirmWithdraw = confirm(`Vas a retirar ${amountBeforeCommission.toFixed(8)} BTC.\n` +
    `Se cobrará una comisión del 5% (${commission.toFixed(8)} BTC).\n` +
    `Monto final a recibir: ${amountAfterCommission.toFixed(8)} BTC.\n\n¿Confirmas el retiro?`);

  if(!confirmWithdraw) return;

  // Aquí iría la llamada real a la API KuCoin para retirar con amountAfterCommission
  // Por ahora solo simulamos el retiro guardando en historial y descontando balance

  balanceBTC = 0;
  balanceDOP = 0;
  saveBalance();
  updateBalances();

  // Guardar retiro en historial
  const history = loadHistory();
  history.push({ amount: amountAfterCommission, date: new Date().toISOString() });
  saveHistory(history);
  showHistory();

  alert("Retiro solicitado con éxito (simulado).");
}

// Eventos botones
document.getElementById('btnConnect').onclick = () => {
  const input = document.getElementById('walletInput').value.trim();
  if(!input) {
    alert("Por favor ingresa tu wallet BTC.");
    return;
  }
  wallet = input;
  loadBalance();
  showHistory();
  document.getElementById('btnStartMine').disabled = false;
  document.getElementById('btnResetMine').disabled = false;
  document.getElementById('btnWithdraw').disabled = false;
  alert(`Wallet ${wallet} conectada.`);
};

document.getElementById('btnStartMine').onclick = () => {
  startMining();
};

document.getElementById('btnResetMine').onclick = () => {
  resetMining();
};

document.getElementById('btnWithdraw').onclick = () => {
  stopMining();
  requestWithdrawal();
};
</script>

</body>
</html>
