
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BTCMovil KuCoin Minero</title>
</head>
<body>
  <h1>Consulta de Saldo y Retiros KuCoin</h1>

  <div>
    <label for="currency">Moneda (Ej: BTC, USDT):</label>
    <input type="text" id="currency" value="BTC" />
    <button onclick="consultarSaldo()">Consultar Saldo</button>
  </div>

  <div>
    <p id="saldo">Saldo: -</p>
  </div>

  <h2>Solicitar Retiro</h2>
  <form id="retiroForm">
    <label>Moneda:</label>
    <input type="text" id="retMoneda" required value="BTC" /><br/>
    <label>Monto:</label>
    <input type="number" step="any" id="retMonto" required /><br/>
    <label>Direcci√≥n:</label>
    <input type="text" id="retDireccion" required /><br/>
    <label>Memo (opcional):</label>
    <input type="text" id="retMemo" /><br/>
    <button type="submit">Enviar Retiro</button>
  </form>

  <h2>Historial de Retiros</h2>
  <ul id="historial"></ul>

  <script>
    const API_BASE = "http://localhost:8000"; // Cambia por tu backend desplegado

    async function consultarSaldo() {
      const currency = document.getElementById('currency').value;
      const res = await fetch(`${API_BASE}/saldo/${currency}`);
      const data = await res.json();
      document.getElementById('saldo').innerText = `Saldo ${data.currency}: ${data.balance}`;
      cargarHistorial();
    }

    async function cargarHistorial() {
      const res = await fetch(`${API_BASE}/historial`);
      const data = await res.json();
      const historial = data.retiros || [];
      const ul = document.getElementById('historial');
      ul.innerHTML = '';
      historial.forEach(item => {
        const li = document.createElement('li');
        const date = new Date(item.timestamp * 1000).toLocaleString();
        li.innerText = `[${date}] ${item.amount} ${item.currency} a ${item.address}`;
        ul.appendChild(li);
      });
    }

    document.getElementById('retiroForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const moneda = document.getElementById('retMoneda').value;
      const monto = parseFloat(document.getElementById('retMonto').value);
      const direccion = document.getElementById('retDireccion').value;
      const memo = document.getElementById('retMemo').value || null;

      if (!moneda || !monto || !direccion) {
        alert("Completa todos los campos obligatorios");
        return;
      }

      const res = await fetch(`${API_BASE}/retiro`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          currency: moneda,
          amount: monto,
          address: direccion,
          memo: memo
        })
      });

      const data = await res.json();
      if (data.success) {
        alert("Retiro solicitado correctamente.");
        cargarHistorial();
        document.getElementById('retiroForm').reset();
      } else {
        alert("Error al solicitar retiro: " + (data.detail || ''));
      }
    });

    window.onload = () => {
      consultarSaldo();
      cargarHistorial();
    };
  </script>
</body>
</html>
